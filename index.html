<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB8dE-UottjPS0dF92H9pfNLO_PcGU05dE",
            authDomain: "prototypingtheapp.firebaseapp.com",
            projectId: "prototypingtheapp",
            storageBucket: "prototypingtheapp.firebasestorage.app",
            messagingSenderId: "732357781797",
            appId: "1:732357781797:web:0ff864827857c15b8312cc",
            measurementId: "G-VSTGVPP0GD"
        };

        // --- Element References ---
        const configErrorScreen = document.getElementById('config-error-screen');

        // --- IMMEDIATE CONFIG CHECK ---
        // This check runs right away. If the config is missing, it shows an error and stops the app from loading.
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIzaSy...your...key...") || firebaseConfig.apiKey.includes("...")) {
            configErrorScreen.classList.remove('hidden');
        } else {
            // --- INITIALIZE APP ---
            // This part only runs if the config check passes.
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            let currentUserId = null;
            let calendar; 

            // --- Get All Other Element References ---
            const authScreen = document.getElementById('auth-screen');
            const dashboardScreen = document.getElementById('dashboard-screen');
            const clientManagementScreen = document.getElementById('client-management-screen');
            const schedulingScreen = document.getElementById('scheduling-screen');
            const allScreens = [authScreen, dashboardScreen, clientManagementScreen, schedulingScreen];
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const showSignupLink = document.getElementById('show-signup-link');
            const showLoginLink = document.getElementById('show-login-link');
            const authErrorMessage = document.getElementById('auth-error-message');
            const logoutButton = document.getElementById('logout-button');
            const manageClientsCard = document.getElementById('manage-clients-card');
            const schedulingCard = document.getElementById('scheduling-card');
            const backToDashboardButton = document.getElementById('back-to-dashboard');
            const backToDashboardFromSchedule = document.getElementById('back-to-dashboard-from-schedule');
            const newClientForm = document.getElementById('new-client-form');
            const clientList = document.getElementById('client-list');
            const editClientModal = document.getElementById('edit-client-modal');
            const editClientForm = document.getElementById('edit-client-form');
            const cancelEditButton = document.getElementById('cancel-edit-button');
            const calendarEl = document.getElementById('calendar');
            const addEventModal = document.getElementById('add-event-modal');
            const addEventForm = document.getElementById('add-event-form');
            const cancelAddEventButton = document.getElementById('cancel-add-event-button');
            const eventClientSelect = document.getElementById('event-client-select');

            // --- Navigation ---
            function showScreen(screenToShow) {
                allScreens.forEach(screen => screen.classList.add('hidden'));
                screenToShow.classList.remove('hidden');
            }

            // --- Authentication Logic ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    showScreen(dashboardScreen);
                    initializeCalendar();
                    fetchAndDisplayClients(); 
                    loadEvents();
                } else {
                    currentUserId = null;
                    showScreen(authScreen);
                    clientList.innerHTML = '';
                    if (calendar) calendar.destroy();
                }
            });

            // --- Calendar Initialization & Logic ---
            function initializeCalendar() {
                if (calendar) calendar.destroy(); // Destroy existing instance if it exists
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
                    dateClick: (info) => {
                        addEventForm.reset();
                        document.getElementById('event-start-date').value = info.dateStr;
                        addEventModal.classList.remove('hidden');
                    },
                    eventClick: (info) => {
                        alert('Event: ' + info.event.title); // Placeholder for editing events
                    }
                });
                calendar.render();
            }

            async function handleAddEvent(e) {
                e.preventDefault();
                if (!currentUserId) return;
                const title = addEventForm['event-title'].value;
                const startDate = addEventForm['event-start-date'].value;
                const clientInfo = addEventForm['event-client-select'].value.split('|');
                const clientId = clientInfo[0];
                const clientName = clientInfo[1];
                const finalTitle = clientName ? `${clientName}: ${title}` : title;
                try {
                    const userEventsCollection = collection(db, 'users', currentUserId, 'events');
                    await addDoc(userEventsCollection, { title: finalTitle, start: startDate, allDay: true, clientId: clientId || null });
                    addEventModal.classList.add('hidden');
                } catch (error) { console.error("Error adding event: ", error); }
            }

            function loadEvents() {
                if (!currentUserId || !calendar) return;
                const userEventsCollection = collection(db, 'users', currentUserId, 'events');
                onSnapshot(userEventsCollection, (snapshot) => {
                    const events = snapshot.docs.map(doc => ({ id: doc.id, title: doc.data().title, start: doc.data().start }));
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                });
            }

            // --- Client Management Logic (Module 2) ---
            function fetchAndDisplayClients() {
                if (!currentUserId) return;
                const userClientsCollection = collection(db, 'users', currentUserId, 'clients');
                onSnapshot(userClientsCollection, (snapshot) => {
                    clientList.innerHTML = '';
                    eventClientSelect.innerHTML = '<option value="">None (General Event)</option>';
                    if (snapshot.empty) {
                        clientList.innerHTML = `<p class="text-gray-500">No clients yet. Add one!</p>`;
                    }
                    snapshot.forEach((doc) => {
                        const client = doc.data();
                        const clientElement = document.createElement('div');
                        clientElement.className = 'bg-white p-4 rounded-lg shadow-sm border';
                        clientElement.innerHTML = `
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg text-purple-700">${client.name}</h3>
                                <p class="text-gray-600">${client.contact}</p>
                            </div>
                            <div class="mt-4 pt-4 border-t flex justify-end space-x-2">
                                <button data-id="${doc.id}" class="edit-btn text-sm font-medium text-blue-600 hover:text-blue-800">Edit</button>
                                <button data-id="${doc.id}" class="delete-btn text-sm font-medium text-red-600 hover:text-red-800">Delete</button>
                            </div>`;
                        clientList.appendChild(clientElement);
                        const optionElement = document.createElement('option');
                        optionElement.value = `${doc.id}|${client.name}`;
                        optionElement.textContent = client.name;
                        eventClientSelect.appendChild(optionElement);
                    });
                });
            }
            
            // --- FIXED: Restored full functions ---
            async function addClient(e) {
                e.preventDefault();
                if (!currentUserId) return;
                const clientName = document.getElementById('client-name').value;
                const clientContact = document.getElementById('client-contact').value;
                const clientNotes = document.getElementById('client-notes').value;
                if (clientName && clientContact) {
                    try {
                        const userClientsCollection = collection(db, 'users', currentUserId, 'clients');
                        await addDoc(userClientsCollection, { name: clientName, contact: clientContact, notes: clientNotes, createdAt: new Date() });
                        newClientForm.reset();
                    } catch (err) { console.error("Error adding document: ", err); }
                }
            }
            async function openEditModal(clientId) {
                const clientRef = doc(db, 'users', currentUserId, 'clients', clientId);
                const docSnap = await getDoc(clientRef);
                if (docSnap.exists()) {
                    const client = docSnap.data();
                    editClientForm['edit-client-id'].value = clientId;
                    editClientForm['edit-client-name'].value = client.name;
                    editClientForm['edit-client-contact'].value = client.contact;
                    editClientForm['edit-client-notes'].value = client.notes;
                    editClientModal.classList.remove('hidden');
                }
            }
            async function handleUpdateClient(e) {
                e.preventDefault();
                const clientId = editClientForm['edit-client-id'].value;
                const clientRef = doc(db, 'users', currentUserId, 'clients', clientId);
                await updateDoc(clientRef, {
                    name: editClientForm['edit-client-name'].value,
                    contact: editClientForm['edit-client-contact'].value,
                    notes: editClientForm['edit-client-notes'].value,
                });
                editClientModal.classList.add('hidden');
            }
            async function handleDeleteClient(clientId) {
                const clientRef = doc(db, 'users', currentUserId, 'clients', clientId);
                await deleteDoc(clientRef);
            }
            
            // --- EVENT LISTENERS ---
            loginForm.addEventListener('submit', async(e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value); loginForm.reset(); authErrorMessage.textContent = ''; } catch (err) { authErrorMessage.textContent = err.message; } });
            signupForm.addEventListener('submit', async(e) => { e.preventDefault(); try { await createUserWithEmailAndPassword(auth, signupForm['signup-email'].value, signupForm['signup-password'].value); signupForm.reset(); authErrorMessage.textContent = ''; } catch (err) { authErrorMessage.textContent = err.message; } });
            logoutButton.addEventListener('click', () => signOut(auth));
            showSignupLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
            manageClientsCard.addEventListener('click', () => showScreen(clientManagementScreen));
            schedulingCard.addEventListener('click', () => showScreen(schedulingScreen));
            backToDashboardButton.addEventListener('click', () => showScreen(dashboardScreen));
            backToDashboardFromSchedule.addEventListener('click', () => showScreen(dashboardScreen));
            newClientForm.addEventListener('submit', addClient);
            editClientForm.addEventListener('submit', handleUpdateClient);
            cancelEditButton.addEventListener('click', () => editClientModal.classList.add('hidden'));
            clientList.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-btn')) openEditModal(e.target.dataset.id);
                if (e.target.classList.contains('delete-btn')) {
                    const btn = e.target;
                    if (btn.dataset.confirming) {
                        handleDeleteClient(btn.dataset.id);
                    } else {
                        document.querySelectorAll('.delete-btn[data-confirming="true"]').forEach(b => { b.textContent = 'Delete'; delete b.dataset.confirming; });
                        btn.textContent = 'Confirm?';
                        btn.dataset.confirming = 'true';
                    }
                }
            });
            addEventForm.addEventListener('submit', handleAddEvent);
            cancelAddEventButton.addEventListener('click', () => addEventModal.classList.add('hidden'));
        }
    </script>
    <style> 
      body { background-color: #f0f2f5; } 
      .fc .fc-button-primary { background-color: #8b5cf6; border-color: #7c3aed; }
      .fc .fc-button-primary:hover { background-color: #7c3aed; border-color: #7c3aed; }
      .fc .fc-today-button { background-color: #6b7280; border-color: #6b7280; }
    </style>
</head>
<body class="font-sans antialiased text-gray-800">

    <!-- NEW: CONFIG ERROR MESSAGE OVERLAY -->
    <div id="config-error-screen" class="hidden fixed inset-0 bg-red-900 text-white p-8 flex items-center justify-center z-50">
        <div class="text-center max-w-2xl">
            <h1 class="text-4xl font-bold mb-4">Configuration Error</h1>
            <p class="text-xl mb-6">Your Firebase API keys are missing from the <code>index.html</code> file.</p>
            <p class="text-lg bg-red-800 p-4 rounded-lg">
                To fix this, you must open the <code>index.html</code> file, find the <code>firebaseConfig</code> object, and replace the placeholder values with the actual keys from your Firebase project console.
            </p>
        </div>
    </div>

    <!-- AUTHENTICATION SCREEN -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center bg-gray-900 text-white p-4">
        <div class="w-full max-w-sm">
            <form id="login-form" class="bg-gray-800 p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6">Log In</h2>
                <div class="mb-4"><label for="login-email" class="block text-gray-400 text-sm font-bold mb-2">Email</label><input type="email" id="login-email" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:border-purple-500" required></div>
                <div class="mb-6"><label for="login-password" class="block text-gray-400 text-sm font-bold mb-2">Password</label><input type="password" id="login-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:border-purple-500" required></div>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 font-bold py-2 px-4 rounded-lg transition-colors">Log In</button>
                <p class="text-center text-sm text-gray-400 mt-4">No account? <a href="#" id="show-signup-link" class="font-bold text-purple-400 hover:underline">Sign up</a></p>
            </form>
            <form id="signup-form" class="bg-gray-800 p-8 rounded-xl shadow-lg hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Sign Up</h2>
                <div class="mb-4"><label for="signup-email" class="block text-gray-400 text-sm font-bold mb-2">Email</label><input type="email" id="signup-email" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:border-purple-500" required></div>
                <div class="mb-6"><label for="signup-password" class="block text-gray-400 text-sm font-bold mb-2">Password (min. 6 characters)</label><input type="password" id="signup-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:border-purple-500" required></div>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 font-bold py-2 px-4 rounded-lg transition-colors">Sign Up</button>
                <p class="text-center text-sm text-gray-400 mt-4">Already have an account? <a href="#" id="show-login-link" class="font-bold text-purple-400 hover:underline">Log in</a></p>
            </form>
            <p id="auth-error-message" class="text-red-400 h-6 mt-4 text-center"></p>
        </div>
    </div>
    
    <!-- DASHBOARD SCREEN -->
    <div id="dashboard-screen" class="hidden">
        <div class="p-4 sm:p-6 md:p-8">
            <header class="flex justify-between items-center pb-4 border-b border-gray-300">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Mission Control</h1>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Log Out</button>
            </header>
            <main class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div id="manage-clients-card" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:scale-105 transition-all cursor-pointer">
                    <h2 class="font-bold text-lg mb-2">Client Management</h2>
                    <p class="text-gray-600">View, add, and edit client profiles.</p>
                </div>
                <div id="scheduling-card" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:scale-105 transition-all cursor-pointer">
                    <h2 class="font-bold text-lg mb-2">Scheduling & Calendar</h2>
                    <p class="text-gray-600">Manage your appointments and bookings.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="font-bold text-lg mb-2">Weekly Earnings</h2>
                    <p class="text-gray-600">$0.00</p>
                </div>
            </main>
        </div>
    </div>
    
    <!-- CLIENT MANAGEMENT SCREEN -->
    <div id="client-management-screen" class="hidden">
        <div class="p-4 sm:p-6 md:p-8">
            <header class="flex items-center pb-4 border-b border-gray-300"><button id="back-to-dashboard" class="mr-4 p-2 rounded-full hover:bg-gray-200 transition-colors"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button><h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Client Management</h1></header>
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1"><h2 class="text-xl font-semibold mb-4">Add New Client</h2><form id="new-client-form" class="bg-white p-6 rounded-xl shadow-md space-y-4"><div><label for="client-name" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="client-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"></div><div><label for="client-contact" class="block text-sm font-medium text-gray-700">Contact Info (Email/Phone)</label><input type="text" id="client-contact" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"></div><div><label for="client-notes" class="block text-sm font-medium text-gray-700">Notes & Preferences</label><textarea id="client-notes" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"></textarea></div><button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save Client</button></form></div>
                <div class="md:col-span-2"><h2 class="text-xl font-semibold mb-4">Your Clients</h2><div id="client-list" class="space-y-4"></div></div>
            </div>
        </div>
    </div>

    <!-- SCHEDULING SCREEN (Module 3) -->
    <div id="scheduling-screen" class="hidden">
        <div class="p-4 sm:p-6 md:p-8">
            <header class="flex items-center pb-4 border-b border-gray-300">
                <button id="back-to-dashboard-from-schedule" class="mr-4 p-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                </button>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Calendar & Bookings</h1>
            </header>
            <main class="mt-6 bg-white p-4 rounded-xl shadow-md">
                <div id='calendar'></div>
            </main>
        </div>
    </div>

    <!-- EDIT CLIENT MODAL -->
    <div id="edit-client-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Edit Client</h3>
            <form id="edit-client-form" class="space-y-4">
                <input type="hidden" id="edit-client-id">
                <div><label for="edit-client-name" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="edit-client-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"></div>
                <div><label for="edit-client-contact" class="block text-sm font-medium text-gray-700">Contact Info</label><input type="text" id="edit-client-contact" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"></div>
                <div><label for="edit-client-notes" class="block text-sm font-medium text-gray-700">Notes & Preferences</label><textarea id="edit-client-notes" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"></textarea></div>
                <div class="items-center gap-4 flex justify-end pt-4">
                    <button id="cancel-edit-button" type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD EVENT MODAL -->
    <div id="add-event-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Appointment</h3>
            <form id="add-event-form" class="space-y-4">
                <div><label for="event-title" class="block text-sm font-medium text-gray-700">Description</label><input type="text" id="event-title" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="event-client-select" class="block text-sm font-medium text-gray-700">Link to Client (Optional)</label><select id="event-client-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select></div>
                <div><label for="event-start-date" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="event-start-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="flex justify-end gap-4 pt-4">
                    <button id="cancel-add-event-button" type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Save Appointment</button>
                </div>
            </form>
        </div>
    </div>
    
</body>
</html>

